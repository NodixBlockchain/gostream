<html>
<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js" ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    
    <script src="/js/opus-stream-decoder.js"></script>
    <script src="/js/audio.js"></script>
    <!-- <script src="/js/elliptic.min.js"></script> -->
    <!-- <script src="/js/browser.js" type="text/javascript"></script> -->
    <!-- <script src="/js/js-ecdsa.min.js"></script> -->
</head>

<style>
    #appel-decline { display:none }
</style>

<body>

  

    <h1 id="moi"></h1>

    <button id="appel" onclick=" call($('#Destination').val(), globalAudio.token); ">appel</button>

    <input type="text" id="Destination" />

    <div class="modal" tabindex="-1" role="dialog"  id="appelModal1" aria-labelledby="appelModal1Label" aria-hidden="true" >
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="appelModal1Label" ></h5>
            </div>
            <div class="modal-body center">
                <span id="appel-calling"></span>
                <span id="appel-decline"></span>
            </div>
            <div class="modal-footer center">
                
                <button class="btn btn-primary"  data-dismiss="modal">fermer</button>
            </div>
          </div>
        </div>
      </div>        


    <div class="modal" tabindex="-1" role="dialog"  id="appelModal" aria-labelledby="appelModalLabel" aria-hidden="true" >
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="appelModalLabel" ></h5>
            </div>
            <div class="modal-body">
                <div id="call-infos"></div>
            </div>
            <div class="modal-footer center">
                <input type="hidden" id="callerID" />
                <button class="btn btn-primary" id="accept-call-btn" onclick="acceptCall($('#callerID').val() ,globalAudio.token);">accept</button> 
                <button class="btn btn-primary" id="reject-call-btn" onclick="rejectCall( $('#callerID').val() ,globalAudio.token);">decline</button>
            </div>
          </div>
        </div>
      </div>    

      <script>

        function call(DestinationID, token)
        {
            $('#appel-calling').css('display','inline');
            $('#appel-calling').html('calling ...');

            $.ajax({
                url: 'http://'+streamServer+'/newCall?Destination='+DestinationID,
                type: 'GET',
                dataType: "text",
                headers: { 'CSRFToken': token},
                success: function (result) {  

                    $('#appel-decline').css('display','none');   
                    $('#appelModal1Label').html('Appel '+ DestinationID); 
                    $('#appelModal1').modal(); 
                },

                error: function (error) { console.log('ajax error "'+error.responseText +'" on URL : "/newCall?Destination='+DestinationID+'"'); }
            }); 
        }        

        function acceptCall(From, token)
        {
            $.ajax({
                url: 'http://'+streamServer+'/acceptCall?From=' + From,
                type: 'GET',
                dataType: "json",
                headers: { 'CSRFToken': token},
                success: function (result) 
                {  
                    startCall(result.roomid,token); 

                    $('#call-infos').html('call established '+result.roomid) 
                },
                error: function (error) { console.log('ajax error "'+error.responseText +'" on URL : "/acceptCall?From='+From+'"'); }
            }); 
        }   
        
        function rejectCall(From, token)
        {
            $.ajax({
                url: 'http://'+streamServer+'/rejectCall?From=' + From,
                type: 'GET',
                dataType: "text",
                headers: { 'CSRFToken': token},
                success: function (result) {   

                    $('#call-infos').html('call from '+From+' rejected ') 

                    $('#accept-call-btn').prop('disabled','disabled'); 
                    $('#reject-call-btn').prop('disabled','disabled'); 
                },
                error: function (error) { console.log('ajax error "'+error.responseText +'" on URL : "/rejectCall?From=' + From+'"'); }
            }); 
        }
  
        function called(data) 
        {

            $('#callerID').val(data.from); 

            $('#call-infos').empty();

            $('#appel-decline').css('display','none'); 

            $('#appel-calling').css('display','none'); 
            $('#appel-calling').empty();

            $('#accept-call-btn').prop('disabled',false); 
            $('#reject-call-btn').prop('disabled',false); 


            $('#appelModalLabel').html('Appel de '+ data.from); 
            $('#appelModal').modal(); 
                
    
        }
        
        function callAccepted(data)
        {
            playCall(data.roomid, globalAudio.token);  
                
            $('#appel-calling').css('display','inline');  
            $('#appel-calling').html('call established '+data.roomid);   

            $('#appel-decline').css('display','none'); 
                
            $('#accept-call-btn').prop('disabled','disabled'); 
            $('#reject-call-btn').prop('disabled','disabled'); 
        }        
        
        function callDeclined(data)
        {
            $('#appel-calling').css('display','none'); 

            $('#appel-decline').css('display','inline'); 
            $('#appel-decline').html(data.from+ ' a declin√© l\'appel ');
        }

        function createEventSource(token)
        {
            var streamSource = new EventSource('http://'+streamServer+'/messages?CSRFtoken=' + token);
            
            streamSource.addEventListener('newCall',function(e){called(JSON.parse(e.data))});
            streamSource.addEventListener('declineCall',function(e){callDeclined(JSON.parse(e.data))});
            streamSource.addEventListener('acceptedCall',function(e){callAccepted(JSON.parse(e.data))});
        }

        /*
        let ec = new elliptic.ec('p256');
                
        var key = ec.genKeyPair();
        var mypub=key.getPublic('hex')

        var msgHash = [ 1, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ];
        var signature = key.sign(msgHash).toDER('hex');        

        console.log("my pub "+mypub)
        console.log("sign "+signature)

        $.ajax({
                url: 'http://localhost/Membres/keyXCHG',
                type: 'POST',
                data: {sign:signature,pubkey:mypub},
                dataType: "json",
                success: function (result) 
                {  
                    console.log('serv key') 
                    console.log(result.pubkey) 

                    var okey = ec.keyFromPublic(result.pubkey,'hex');

                    var AB = okey.getPublic().mul(key.getPrivate())

                    console.log('shared key') 
                    console.log(AB.getX().toString(16)) 
                    console.log(AB.getY().toString(16)) 
                },
                error: function (error) { console.log('ajax error "'+error.responseText +'" on URL : "tokenCheck"'); }
            }); 
        */

    
        $.getJSON('http://localhost/Membres/newCRSF', function(result)  {

            console.log('token result : ')
            console.log(result)

            $.ajax({
                url: 'http://'+streamServer+'/tokenCheck',
                type: 'GET',
                dataType: "text",
                headers: { 'CSRFToken': result.token},
                success: function (userID) { $('#moi').html( 'moi : ' + userID ); globalAudio.token = result.token;  createEventSource(result.token); },
                error: function (error) { console.log('ajax error "'+error.responseText +'" on URL : "' + url+'"'); }
            });            

           
        });
    
        </script>

</body>


</html>